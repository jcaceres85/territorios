function initTree(){$("#layerTree").tree({data:layerData,dragAndDrop:!0,autoEscape:!1,closedIcon:$('<i class="fas fa-angle-right"></i>'),openedIcon:$('<i class="fas fa-angle-down"></i>'),onCanMoveTo:function(e,r,a){return"category"==r.type?"inside"==a||"before"==a||"after"==a:"before"==a||"after"==a}}),$("#menuTree").tree({data:menuData,dragAndDrop:!0,autoEscape:!1,closedIcon:$('<i class="fas fa-angle-right"></i>'),openedIcon:$('<i class="fas fa-angle-down"></i>'),onCanMoveTo:function(e,r,a){return"container"==r.type?"inside"==a||"before"==a||"after"==a:"before"==a||"after"==a}})}function initMap(){coordIni=ol.proj.transform(coordIni,"EPSG:4326","EPSG:3857"),null!=zoomIni&&""!=zoomIni||(zoomIni=10),map_view=new ol.View({center:coordIni,zoom:zoomIni}),lyrBingMapsAerial=new ol.layer.Tile({visible:"bingaerial"==baseLayer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"Aerial"})}),lyrBingMapsAerialWithLabels=new ol.layer.Tile({visible:"bingaeriallabels"==baseLayer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"AerialWithLabels"})}),lyrBingMapsRoad=new ol.layer.Tile({visible:"bingroad"==baseLayer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"Road"})}),lyrOSM=new ol.layer.Tile({visible:"osm"==baseLayer,source:new ol.source.OSM}),lyrEsriWorldStreetMap=new ol.layer.Tile({visible:"esriworldstreetmap"==baseLayer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldImagery=new ol.layer.Tile({visible:"esriworldimagery"==baseLayer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldTerrain=new ol.layer.Tile({visible:"esriworldterrain"==baseLayer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldShadedRelief=new ol.layer.Tile({visible:"esriworldshadedrelief"==baseLayer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldPhysical=new ol.layer.Tile({visible:"esriworldphysical"==baseLayer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}"})}),lyrStamenTerrain=new ol.layer.Tile({visible:"stamen_terrain"==baseLayer,source:new ol.source.Stamen({layer:"terrain"})}),lyrStamenToner=new ol.layer.Tile({visible:"stamen_toner"==baseLayer,queryable:!1,source:new ol.source.Stamen({layer:"toner"})}),map=new ol.Map({layers:[lyrBingMapsAerialWithLabels,lyrBingMapsAerial,lyrBingMapsRoad,lyrOSM,lyrEsriWorldPhysical,lyrEsriWorldTerrain,lyrEsriWorldImagery,lyrEsriWorldShadedRelief,lyrEsriWorldStreetMap,lyrStamenTerrain,lyrStamenToner],interactions:ol.interaction.defaults({altShiftDragRotate:!1,rotate:!1}),target:"map",view:map_view});var e=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",className:"custom-mouse-position",target:document.getElementById("mouse-position"),undefinedHTML:"&nbsp;"}),r=map.getView().getZoom();map_zoom=r,$("#zoom").html("Zoom: "+r),map.on("moveend",function(){r!=map.getView().getZoom()&&(r=map.getView().getZoom(),map_zoom=parseFloat(map.getView().getZoom()).toFixed(2),$("#zoom").html("Zoom: "+map_zoom))}),map.addControl(e);var a=new ol.control.ScaleLine;map.addControl(a);var o=new ol.control.FullScreen;map.addControl(o),new ol.control.OverviewMap({layers:[lyrBingMapsAerialWithLabels,lyrBingMapsAerial,lyrBingMapsRoad,lyrOSM,lyrEsriWorldPhysical,lyrEsriWorldTerrain,lyrEsriWorldImagery,lyrEsriWorldShadedRelief,lyrEsriWorldStreetMap,lyrStamenTerrain,lyrStamenToner]}).setMap(map),graticule=new ol.Graticule({strokeStyle:new ol.style.Stroke({color:"rgba(0,0,0,0.9)",width:2}),showLabels:!0}),map.on("click",function(e){})}function openLayerTree(){panelLayerTree=jsPanel.create({id:"panelLayerTree",theme:"primary",contentSize:{width:function(){return Math.min(400,window.innerWidth/4)},height:function(){return window.innerHeight-200}},position:"left-top 10 70",animateIn:"jsPanelFadeIn",headerControls:{close:"remove"},dragit:{containment:[60,10,10,10]},headerTitle:'<i class="info circle icon"></i> Configurar capas',content:"",onwindowresize:!0})}function clickIdentify(e){new_click=!0,lyrResult.getSource().clear(),visibleLayers.length>0&&getInfo(0,e.coordinate)}function mostrarResultado(e){new_click?(new_click=!1,mostrarPanelResultado("")):$("#panel_info_content").append("")}function getInfo(e,r){var a=visibleLayers[e],o=getCapa(a),l=o.get("name"),i=o.get("geoserver_layer_id"),t=o.getSource().getGetFeatureInfoUrl(r,map.getView().getResolution(),map.getView().getProjection(),{INFO_FORMAT:"text/javascript",query_layers:o.getSource().getParams().layers});if(t){var n=new ol.format.GeoJSON({featureProjection:"EPSG:4326"});$.ajax({url:t,dataType:"jsonp",jsonpCallback:"parseResponse"}).then(function(a){var o=n.readFeatures(a);if(o.length){var t=o[0].getKeys();content="<span>"+l+"</span>",content+='<table class="tabla-info ui celled table">',content+="<tbody>";for(var s=0;s<t.length;s++){var c=t[s];if("geometry"!=c){var d=!1,m="";$.each(diccionario,function(e,r){i==r.capa&&c==r.campo&&(m=r.etiqueta,d=!0)}),d&&(content+="<tr><td>"+m+"</td><td>"+o[0].get(c)+"</td></tr>")}}content+="</tbody>",content+="</table>",new_click?(new_click=!1,mostrarPanelResultado(content)):$("#panel_info_content").append(content),lyrResult.getSource().addFeatures(o)}++e<visibleLayers.length&&getInfo(e,r)})}}function mostrarPanelResultado(e){null==panelInfo?panelInfo=jsPanel.create({id:"panelInfo",theme:"primary",contentSize:{width:function(){return Math.min(400,window.innerWidth/4)},height:function(){return 400}},position:"right-top 10 70",animateIn:"jsPanelFadeIn",headerTitle:'<i class="info circle icon"></i> Información',dragit:{snap:!0},content:'<div id="panel_info_content">'+e+"</div>",onwindowresize:!0}):$("#panel_info_content").html(e)}function onMapClick(e){clickIdentify(e)}var cat_count_id,menu_count_id,file_uploaded="";function initControls(){tinymce.init({selector:"#geovisor_msj_ini",plugins:"code link table media preview fullscreen image",spellchecker_language:"es",height:"480",language:"es",images_upload_url:"upload.php"}),tinymce.init({selector:".text-item",plugins:"code link table media preview fullscreen image",spellchecker_language:"es",language:"es",height:"600",images_upload_url:"upload.php"}),$(".menu .item").tab(),$(".checkbox").checkbox(),new Dropzone("#upload_image",{url:"lib/actions/upload_image.php",maxFiles:1,maxFilesize:2,addRemoveLinks:!0,acceptedFiles:".jpg, .jpeg, .png",accept:function(e,r){e.name.endsWith(".png")||e.name.endsWith(".jpg")||e.name.endsWith(".jpeg")?(r(),file_uploaded=e.name):r("El formato de los archivos tienen que ser .jpg, .jpeg o .png")},dictRemoveFile:"Eliminar archivo",dictInvalidFileType:"El formato del archivo no es válido"}).on("complete",function(e){$("#img_logo_src").val(file_uploaded),$("#img_logo").attr("src","uploads/"+file_uploaded),$("#modalImageGeovisor").modal("hide")}),$(".dropdown").dropdown({}),$("#search_layer_id_form").dropdown({fullTextSearch:!0,onChange:function(e){changeLayerFormSearch(e)}}),$("#search_attribute_form").dropdown({fullTextSearch:!0}),$("#base_layer").on("change",function(){selectBaseLayer()}),$("#selectLayer").dropdown({apiSettings:{url:"lib/xajax/x_search_layers_by_title.php?title={query}"}}),$("#selectStyle").dropdown({apiSettings:{url:"lib/xajax/x_search_styles_by_title.php?title={query}"}}),$("#form-geovisor").form({}),$("#type_menu_form").on("change",function(){var e=$("#type_menu_form").val();"container"==e?($("#field_menu_link").hide(),$("#field_menu_html").hide()):"link"==e?($("#field_menu_link").show(),$("#field_menu_html").hide()):"html"==e&&($("#field_menu_link").hide(),$("#field_menu_html").show())})}function initPopups(){$("#modalFormLayer").modal({closable:!1,allowMultiple:!0,onDeny:function(){return!0},onApprove:function(){var e;if("add"==(a=$("#form_layer_action").val()))e=$("#layerTree").tree("getSelectedNode"),$("#id_layer_form").val();else{var r=$("#lyr_edit_id").val();(e=$("#layerTree").tree("getNodeById","lyr"+r)).lyr_id}var a=$("#form_layer_action").val(),o=$("#id_layer_form").val(),l=$("#name_layer_form").val(),i=$("#geoserver_url_layer_form").val(),t=$("#style_layer_form").val(),n=$("#transparency_layer_form").val(),s=$("#zindex_layer_form").val(),c=$("#active_layer_form").prop("checked")?"t":"f",d=$("#queryable_layer_form").prop("checked")?"t":"f",m=$("#tiled_layer_form").prop("checked")?"t":"f",_=$("#label_style_id_layer_form").val(),y=$("#label_active_layer_form").prop("checked")?"t":"f",u=$("#label_zoom_min_layer_form").val(),v=$("#label_zoom_max_layer_form").val(),p=o;null!=t&&""!=t&&(p=t);var f='<div><i class="map icon"></i> '+l+" <span onclick=\"activateLayer('"+p+'\')"><i class="eye icon"></i></span><span onclick="editLayer(\''+p+'\')"><i class="edit icon"></i></span><span onclick="removeLayer(\''+p+'\')"><i class="remove icon"></i></span><div> <img src="'+i+"/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER="+o;null!=t&&""!=t&&(f+="&STYLE="+t),f+="&LEGEND_OPTIONS=bgColor:0xFFFFFF;fontSize:9;fontColor:0x333333;forceLabels:on&access_token="+access_token+'"/></div><div>';var g=new ol.layer.Tile({visible:!1,source:new ol.source.TileWMS({url:i+"/wms",params:{FORMAT:"image/png",VERSION:"1.1.1",tiled:!0,STYLES:o,access_token:access_token,LAYERS:o},serverType:"geoserver"}),opacity:.9});if(g.set("geoserver_layer_id",o),g.set("name",l),g.setZIndex(s),"add"==a){var h={id:"lyr"+p,name:f,type:"layer",geoserver_layer_id:o,lyr_name:l,geoserver_url:i,geoserver_style_id:t,transparency:n,zindex:s,active:c,queryable:d,tiled:m,geoserver_label_style_id:_,label_active:y,label_zoom_min:u,label_zoom_max:v};e?$("#layerTree").tree("addNodeAfter",h,e):$("#layerTree").tree("appendNode",h)}else if("edit"==a){$("#layerTree").tree("updateNode",e,{id:"lyr"+p,name:f,geoserver_layer_id:o,lyr_name:l,geoserver_url:i,geoserver_style_id:t,transparency:n,zindex:s,active:c,queryable:d,tiled:m,geoserver_label_style_id:_,label_active:y,label_zoom_min:u,label_zoom_max:v});var b=lyrsMap[r];null!=b&&map.removeLayer(b)}lyrsMap[p]=g,map.addLayer(g),$("#layerTree").tree("refresh")}}),$("#modalFormCategory").modal({closable:!1,onDeny:function(){return!0},onApprove:function(){var e=$("#form_category_action").val(),r=$("#name_category_form").val(),a=$("#expanded_layer_form").prop("checked")?"t":"f";if("add"==e){var o=$("#layerTree").tree("getSelectedNode");999}else{var l=$("#cat_id").val();(o=$("#layerTree").tree("getNodeById","cat"+l)).cat_id}var i='<div><i class="folder icon"></i> '+r+' <span onclick="editCategory('+l+')"><i class="edit icon"></i></span><span onclick="removeCategory('+l+')"><i class="remove icon"></i></span></div>';if("add"==e){var t={id:456,type:"category",name:i,category_name:r,expanded:a};o?$("#layerTree").tree("addNodeAfter",t,o):$("#layerTree").tree("appendNode",t)}else"edit"==e&&$("#layerTree").tree("updateNode",o,{id:"cat"+l,name:i,category_name:r,expanded:a});$("#layerTree").tree("refresh")}}),$("#modalFormSearch").modal({closable:!1,allowMultiple:!0,onDeny:function(){return!0},onApprove:function(){var e=$("#form_search_action").val(),r=$("#search_id_form").val(),a=$("#search_text_form").val(),o=$("#search_layer_id").val(),l=$("#search_layer_id_form .text").html(),i=$("#search_attribute").val(),t=$("#search_attribute_form .text").html(),n=$('input[name="search_type_form"]:checked').val();if("add"==e){r=listSearch.length+1;for(var s=0;s<listSearch.length;s++){var c=parseInt(listSearch[s].search_id);c>=r&&(r=c+1)}listSearch.push({search_id:r,layer_id:o,layer_name:l,attribute:i,attribute_label:t,type:n,search_text:a}),refreshSearchList()}else listSearch.splice(r-1,1,{search_id:r,layer_id:o,layer_name:l,attribute:i,attribute_label:t,type:n,search_text:a}),refreshSearchList()}}),$("#modalFormMenu").modal({closable:!1,onDeny:function(){return!0},onApprove:function(){var e,r=$("#form_menu_action").val(),a=$("#name_menu_form").val(),o=$("#type_menu_form").val(),l="";switch(o){case"html":l=tinymce.get("content_menu_form").getContent();break;case"link":l=$("#menu_link_form").val();break;case"contanier":l=""}if("add"==r)e=$("#menuTree").tree("getSelectedNode"),i=999;else{var i=$("#id_menu_form").val();i=(e=$("#menuTree").tree("getNodeById",i)).menu_id}var t="folder";switch(o){case"contanier":t="folder";break;case"link":t="linkify";break;case"html":t="edit"}var n='<div><i class="'+t+' icon"></i> '+a+' <span onclick="editMenuItem('+i+')"><i class="edit icon"></i></span><span onclick="removeMenuItem('+i+')"><i class="remove icon"></i></span></div>';if("add"==r){var s={id:456,name:n,menu_name:a,type:o,content:l};e?$("#menuTree").tree("addNodeAfter",s,e):$("#menuTree").tree("appendNode",s)}else"edit"==r&&$("#menuTree").tree("updateNode",e,{id:"menu"+i,name:n,menu_name:a,type:o,content:l});$("#menuTree").tree("refresh")}}),$("#modalImageGeovisor").modal({closable:!1,onDeny:function(){return!0},onApprove:function(){}}),$("#modalSearchLayer").modal({closable:!1,allowMultiple:!0,onDeny:function(){return!0},onApprove:function(){var e=$("#selectLayer").find(".text").html(),r=$("#selected_layer").val();$("#id_layer_form").val(r),$("#name_layer_form").val(e)}}),$("#modalSearchStyle").modal({closable:!1,allowMultiple:!0,onDeny:function(){return!0},onApprove:function(){var e=$("#selected_style").val();$("#label_style_id_layer_form").val(e)}}),$("#modalSearchLayer").modal("attach events","#modalFormLayer .btn-search-layer"),$("#modalSearchStyle").modal("attach events","#modalFormLayer .btn-search-style")}function selectBaseLayer(){var e=$("#base_layer").val();switch(lyrBingMapsAerial.setVisible(!1),lyrBingMapsAerialWithLabels.setVisible(!1),lyrBingMapsRoad.setVisible(!1),lyrOSM.setVisible(!1),lyrStamenTerrain.setVisible(!1),lyrStamenToner.setVisible(!1),lyrEsriWorldPhysical.setVisible(!1),lyrEsriWorldTerrain.setVisible(!1),lyrEsriWorldImagery.setVisible(!1),lyrEsriWorldShadedRelief.setVisible(!1),lyrEsriWorldStreetMap.setVisible(!1),e){case"bingaerial":lyrBingMapsAerial.setVisible(!0);break;case"bingaeriallabels":lyrBingMapsAerialWithLabels.setVisible(!0);break;case"bingroad":lyrBingMapsRoad.setVisible(!0);break;case"osm":lyrOSM.setVisible(!0);break;case"stamen_terrain":lyrStamenTerrain.setVisible(!0);break;case"stamen_toner":lyrStamenToner.setVisible(!0);break;case"esriworldphysical":lyrEsriWorldPhysical.setVisible(!0);break;case"esriworldshadedrelief":lyrEsriWorldShadedRelief.setVisible(!0);break;case"esriworldterrain":lyrEsriWorldTerrain.setVisible(!0);break;case"esriworldimagery":lyrEsriWorldImagery.setVisible(!0);break;case"esriworldstreetmap":lyrEsriWorldStreetMap.setVisible(!0)}}function changeLogoImage(){$("#modalImageGeovisor").modal("show")}function openSearchLayer(){}function newCategory(){$("#title_category_form").html('<i class="folder icon"></i> Nueva categoría: '),$("#form_category_action").val("add"),$("#name_category_form").val(""),$("#expanded_layer_form").prop("checked",!1),$("#modalFormCategory").modal("show")}function editCategory(e){var r=$("#layerTree").tree("getNodeById","cat"+e);$("#form_category_action").val("edit"),$("#cat_id").val(e),$("#title_category_form").html('<i class="folder icon"></i> Editar categoría: '+r.category_name),$("#name_category_form").val(r.category_name),$("#expanded_layer_form").prop("checked","t"==r.expanded),$("#modalFormCategory").modal("show")}function removeCategory(e){var r=$("#layerTree").tree("getNodeById","cat"+e);$("#layerTree").tree("removeNode",r)}function newLayer(){$("#title_layer_form").html('<i class="map icon"></i> Nueva capa'),$("#form_layer_action").val("add"),$("#id_layer_form").val(""),$("#name_layer_form").val(""),$("#geoserver_url_layer_form").val(GEOSERVER_BASE_URL),$("#style_layer_form").val(""),$("#transparency_layer_form").val("100"),$("#zindex_layer_form").val("1"),$("#active_layer_form").prop("checked",!1),$("#queryable_layer_form").prop("checked",!0),$("#tiled_layer_form").prop("checked",!0),$("#label_style_id_layer_form").val(""),$("#label_active_layer_form").prop("checked",!1),$("#label_zoom_min_layer_form").val(""),$("#label_zoom_max_layer_form").val(""),$("#modalFormLayer").modal("show")}function editLayer(e){var r=$("#layerTree").tree("getNodeById","lyr"+e);$("#title_layer_form").html('<i class="map icon"></i> Editar capa: '+r.lyr_name),$("#form_layer_action").val("edit"),$("#lyr_edit_id").val(e),$("#id_layer_form").val(r.geoserver_layer_id),$("#name_layer_form").val(r.lyr_name),$("#geoserver_url_layer_form").val(r.geoserver_url),$("#style_layer_form").val(r.geoserver_style_id),$("#transparency_layer_form").val(r.transparency),$("#zindex_layer_form").val(r.zindex),$("#active_layer_form").prop("checked","t"==r.active),$("#queryable_layer_form").prop("checked","t"==r.queryable),$("#tiled_layer_form").prop("checked","t"==r.tiled),$("#label_style_id_layer_form").val(r.geoserver_label_style_id),$("#label_active_layer_form").prop("checked","t"==r.label_active),$("#label_zoom_min_layer_form").val(r.label_zoom_min),$("#label_zoom_max_layer_form").val(r.label_zoom_max),$("#modalFormLayer").modal("show")}function removeLayer(e){var r=$("#layerTree").tree("getNodeById","lyr"+search_id);$("#layerTree").tree("removeNode",r)}function newMenuItem(){$("#title_menu_form").html('<i class="map icon"></i> Nuevo menú'),$("#form_menu_action").val("add"),$("#id_menu_form").val(""),$("#name_menu_form").val(""),$("#type_menu_form").val("container"),$("#type_menu_form").dropdown("set selected","container"),$("#field_menu_html").hide(),$("#field_menu_link").hide(),tinymce.get("content_menu_form").setContent(""),$("#modalFormMenu").modal("show")}function editMenuItem(e){var r=$("#menuTree").tree("getNodeById","menu"+e);switch($("#title_menu_form").html('<i class="map icon"></i> Editar menú '+r.menu_name),$("#form_menu_action").val("edit"),$("#id_menu_form").val(r.id),$("#name_menu_form").val(r.menu_name),$("#type_menu_form").dropdown("set selected",r.type),$("#type_menu_form").val(r.type),r.type){case"html":tinymce.get("content_menu_form").setContent(r.content),$("#field_menu_html").show(),$("#field_menu_link").hide();break;case"link":$("#menu_link_form").val(r.content),$("#field_menu_html").hide(),$("#field_menu_link").show();break;case"contanier":$("#field_menu_html").hide(),$("#field_menu_link").hide()}$("#modalFormMenu").modal("show")}function removeMenuItem(e){var r=$("#menuTree").tree("getNodeById","menu"+e);$("#menuTree").tree("removeNode",r)}function getSearch(e){for(var r=null,a=0;a<listSearch.length;a++)if(listSearch[a].search_id==e){r=listSearch[a];break}return r}function newSearch(){$("#title_search_form").html('<i class="search icon"></i> Nueva búsqueda: '),$("#form_search_action").val("add"),$("#search_id_form").val(""),$("#search_text_form").val(""),$("#search_layer_id_form").dropdown("set selected",""),changeLayerFormSearch(null),$("#search_type_select_form").checkbox("check"),$("#modalFormSearch").modal("show")}function editSearch(e){var r=getSearch(e);null!=r&&($("#form_search_action").val("edit"),$("#search_id_form").val(e),$("#search_text_form").val(r.search_text),$("#search_layer_id_form").dropdown("set selected",r.layer_id),changeLayerFormSearch(r.layer_id,r.attribute),"select"==r.type?$("#search_type_select_form").checkbox("check"):"text"==r.type?$("#search_type_text_form").checkbox("check"):"checkbox"==r.type&&$("#search_type_checkbox_form").checkbox("check"),$("#modalFormSearch").modal("show"))}function removeSearch(e){listSearch.splice(e-1,1),refreshSearchList()}function refreshSearchList(){$("#search-table tbody").html("");for(var e=0;e<listSearch.length;e++){var r=listSearch[e],a="<tr><td>"+r.search_id+"</td><td>"+r.layer_name+"</td><td>"+r.attribute+"</td><td>"+r.attribute_label+"</td><td>"+r.type+"</td><td>"+r.search_text+'</td><td><button onclick="editSearch('+r.search_id+');" class="circular ui primary mini icon button"><i class="edit icon"></i></button><button onclick="removeSearch('+r.search_id+');" class="circular ui red mini icon button"><i class="trash alternate icon"></i></button></td></tr>';$("#search-table tbody").append(a)}}function changeLayerFormSearch(e,r=null){null!=e&&""!=e?$.ajax({url:"lib/xajax/x_get_attribute_by_layer.php?id="+e,dataType:"json",success:function(e){$("#search_attribute_form .menu").html("");for(var a=0;a<e.results.length;a++){var o=e.results[a];$("#search_attribute_form .menu").append('<div class="item" data-value="'+o.attribute+'">'+o.label+"</div>")}$("#search_attribute_form").dropdown("set selected",r)},error:function(e,r,a){window.console&&console.log(r+" - "+a)}}):$("#search_attribute_form .menu").html("")}function getTreeNode(e,r,a){if(null==e.parent||"category"==e.type){cat_count_id++;var o={type:e.type,category_id:cat_count_id,category_name:e.category_name,expanded:e.expanded,parent_category_id:r};a.push(o);for(var l=0;l<e.children.length;l++){getTreeNode(e.children[l],o.category_id,a)}}else a.push({type:e.type,geoserver_layer_id:e.geoserver_layer_id,lyr_name:e.lyr_name,geoserver_url:e.geoserver_url,geoserver_style_id:e.geoserver_style_id,transparency:e.transparency,zindex:e.zindex,active:e.active,queryable:e.queryable,tiled:e.tiled,geoserver_label_style_id:e.geoserver_label_style_id,label_active:e.label_active,label_zoom_min:e.label_zoom_min,label_zoom_max:e.label_zoom_max,category_id:r})}function getTreeMenu(e,r,a){if(e){menu_count_id++;var o={type:e.type,id:menu_count_id,name:e.menu_name,content:e.content,parent_id:r};a.push(o);for(var l=0;l<e.children.length;l++){getTreeMenu(e.children[l],o.id,a)}}}function saveGeovisorForm(){var e=!0,r=$("#action").val();null!=r&&""!=r.trim()||(e=!1);var a=$("#geovisor_id").val();null!=a&&""!=a.trim()||(e=!1);var o=$("#geovisor_name").val();null!=o&&""!=o.trim()||(toastr.error("Debes de escribir un nombre."),e=!1);var l=$("#geovisor_slug").val();null!=l&&""!=l.trim()||(toastr.error("Debes de ingresar una URL (slug)."),e=!1);var i=$("#geovisor_is_public").prop("checked")?"t":"f",t=$("#geovisor_title").val();null!=t&&""!=t.trim()||(toastr.error("Debes de ingresar un título."),e=!1);var n=$("#geovisor_coord").val();null!=n&&""!=n.trim()||(toastr.error("Debes de ingresar coordenadas iniciales."),e=!1);var s=$("#geovisor_zoom").val();null==s||""==s.trim()?(toastr.error("Debes de ingresar un nivel de zoom inicial."),e=!1):isNaN(s)&&(toastr.error("El nivel de zoom inicial debe ser un número entero."),e=!1);var c=$("#geovisor_zoom_min").val();null==c||""==c.trim()?(toastr.error("Debes de ingresar un zoom mínimo."),e=!1):isNaN(c)&&(toastr.error("El nivel de zoom inicial debe ser un número entero."),e=!1);var d=$("#geovisor_zoom_max").val();if(null==d||""==d.trim()?e=!1:isNaN(d)&&(toastr.error("El nivel de zoom inicial debe ser un número entero."),e=!1),!isNaN(c)&&!isNaN(d)){var m=parseInt(s),_=parseInt(c),y=parseInt(d);_>y&&(toastr.error("El nivel de zoom mínimo debe ser menor al zoom máximo."),e=!1),(m<_||m>y)&&(toastr.error("El nivel de zoom inicial debe estar entre el zoom mínimo y el zoom máximo."),e=!1)}var u=$("#geovisor_msj_ini").val();null!=u&&""!=u.trim()||(toastr.error("Debes de ingresar un zoom máximo."),e=!1);var v=$("#img_logo_src").val();null!=v&&""!=v.trim()||(e=!1);var p=$("#base_layer").val(),f=$("#geovisor_primary_color").val(),g=$("#geovisor_secondary_color").val(),h=$("#custom_css").val(),b=$("#geovisor_main_font").val(),S=$("#geovisor_main_font_size").val(),w=$("#geovisor_legend_font").val(),k=$("#geovisor_legend_font_size").val();if(e){var T=[];getTreeNode($("#layerTree").tree("getTree"),cat_count_id=-1,T);var x=[];getTreeMenu($("#menuTree").tree("getTree"),menu_count_id=-1,x);var L={geovisor_id:a,action:r,geovisor_name:o,geovisor_slug:l,geovisor_is_public:i,geovisor_title:t,geovisor_coord:n,geovisor_zoom:s,geovisor_zoom_min:c,geovisor_zoom_max:d,geovisor_msj_ini:u,img_logo_src:v,base_layer:p,primary_color:f,secondary_color:g,custom_css:h,main_font:b,main_font_size:S,legend_font:w,legend_font_size:k,tree:T,treeMenu:x,searches:listSearch};$("#btnSaveGeovisor").addClass("disabled"),$("#btnSaveGeovisor").addClass("loading"),console.log(JSON.stringify(L)),$.post("lib/xajax/x_set_geovisor.php",JSON.stringify(L)).done(function(e){res=JSON.parse(e),res.success&&toastr.info("Guardado con éxito."),$("#btnSaveGeovisor").removeClass("disabled"),$("#btnSaveGeovisor").removeClass("loading")})}}function validateGeovisorForm(){}function cancelGeovisorForm(){$(location).attr("href","admin.php?&access_token="+access_token)}function getLayer(e){return lyrsMap[e]}function activateLayer(e){var r=getLayer(e);null!=r&&(r.getVisible()?(r.setVisible(!1),r instanceof ol.layer.Tile&&visibleLayers.splice(visibleLayers.indexOf(e),1)):(r.setVisible(!0),r instanceof ol.layer.Tile&&visibleLayers.push(e)))}function setCurrentCoord(){var e=ol.proj.transform(map.getView().getCenter(),"EPSG:3857","EPSG:4326"),r=ol.coordinate.createStringXY(4)(e);$("#geovisor_coord").val(r)}function setCurrentZoomIni(){$("#geovisor_zoom").val(map.getView().getZoom())}function setCurrentZoomMin(){$("#geovisor_zoom_min").val(map.getView().getZoom())}function setCurrentZoomMax(){$("#geovisor_zoom_max").val(map.getView().getZoom())}initTree(),initMap(),initControls(),initPopups();