var map,map_extent,map_view,graticule,overview,activeTool,lyr,lyrQueryBuffer,lyrBingMapsAerialWithLabels,lyrBingMapsAerial,lyrBingMapsRoad,lyrOSM,lyrStamenTerrain,lyrStamenToner,lyrEsriWorldStreetMap,lyrEsriWorldImagery,lyrEsriWorldTerrain,lyrEsriWorldShadedRelief,lyrEsriWorldPhysical,select,lyrResult,panelInfo,panelBuffer,panelMetadatos,measureLayer,sourceMeasure,drawMeasure,pointerMoveHandler,sketch,helpTooltipElement,helpTooltip,measureTooltipElement,measureTooltip,new_click=!1,lyrsMap={},visibleLayers=[],navigationHistory=[],navigationHistoryFwd=[],shouldUpdate=!0,firstNav=!0;function initMap(){var e=new ol.style.Circle({radius:7,fill:null,stroke:new ol.style.Stroke({color:"yellow",width:2})}),r={Point:new ol.style.Style({image:e}),LineString:new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",width:2})}),MultiLineString:new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",width:2})}),MultiPoint:new ol.style.Style({image:e}),MultiPolygon:new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",width:2}),fill:new ol.style.Fill({color:"rgba(255, 255, 0, 0.1)"})}),Polygon:new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",lineDash:[4],width:3}),fill:new ol.style.Fill({color:"rgba(255, 255, 0, 0.1)"})}),GeometryCollection:new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",width:2}),fill:new ol.style.Fill({color:"yellow"}),image:new ol.style.Circle({radius:10,fill:null,stroke:new ol.style.Stroke({color:"yellow"})})}),Circle:new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",width:2}),fill:new ol.style.Fill({color:"rgba(255, 255, 0, 0.1)"})})},o=[new ol.style.Style({stroke:new ol.style.Stroke({color:"yellow",lineDash:[4],width:3}),fill:new ol.style.Fill({color:"rgba(255, 255, 0, 0.1)"})}),new ol.style.Style({image:new ol.style.Icon({anchor:[.5,46],anchorXUnits:"fraction",anchorYUnits:"pixels",src:"img/icons/buffer.png"})})];map_view=new ol.View({center:coord_ini,zoom:zoom_ini,minZoom:zoom_min,maxZoom:zoom_max}),lyrQueryBuffer=new ol.layer.Vector({source:new ol.source.Vector,style:o,zIndex:1e3}),lyrBingMapsAerial=new ol.layer.Tile({visible:"bingaerial"==base_layer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"Aerial"})}),lyrBingMapsAerial2=new ol.layer.Tile({visible:"bingaerial"==base_layer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"Aerial"})}),lyrBingMapsAerialWithLabels=new ol.layer.Tile({visible:"bingaeriallabels"==base_layer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"AerialWithLabels"})}),lyrBingMapsAerialWithLabels2=new ol.layer.Tile({visible:"bingaeriallabels"==base_layer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"AerialWithLabels"})}),lyrBingMapsRoad=new ol.layer.Tile({visible:"bingroad"==base_layer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"Road"})}),lyrBingMapsRoad2=new ol.layer.Tile({visible:"bingroad"==base_layer,preload:1/0,queryable:!1,source:new ol.source.BingMaps({key:"AiXpl_iJ9vka91ugxW5OybC2RWcH9RJvBjbQDzh9TgZryPAP9-YdO6ig1Bj-qV85",imagerySet:"Road"})}),lyrOSM=new ol.layer.Tile({visible:"osm"==base_layer,source:new ol.source.OSM}),lyrOSM2=new ol.layer.Tile({visible:"osm"==base_layer,source:new ol.source.OSM}),lyrEsriWorldStreetMap=new ol.layer.Tile({visible:"esriworldstreetmap"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldStreetMap2=new ol.layer.Tile({visible:"esriworldstreetmap"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldImagery=new ol.layer.Tile({visible:"esriworldimagery"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldImagery2=new ol.layer.Tile({visible:"esriworldimagery"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldTerrain=new ol.layer.Tile({visible:"esriworldterrain"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldTerrain2=new ol.layer.Tile({visible:"esriworldterrain"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldShadedRelief=new ol.layer.Tile({visible:"esriworldshadedrelief"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldShadedRelief2=new ol.layer.Tile({visible:"esriworldshadedrelief"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldPhysical=new ol.layer.Tile({visible:"esriworldphysical"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}"})}),lyrEsriWorldPhysical2=new ol.layer.Tile({visible:"esriworldphysical"==base_layer,title:"Esri.ShadedRelief",baseLayer:!0,source:new ol.source.XYZ({url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}"})}),lyrStamenTerrain=new ol.layer.Tile({visible:"stamen_terrain"==base_layer,source:new ol.source.Stamen({layer:"terrain"})}),lyrStamenTerrain2=new ol.layer.Tile({visible:"stamen_terrain"==base_layer,source:new ol.source.Stamen({layer:"terrain"})}),lyrStamenTerrain2=new ol.layer.Tile({visible:"stamen_terrain"==base_layer,source:new ol.source.Stamen({layer:"terrain"})}),lyrStamenToner=new ol.layer.Tile({visible:"stamen_toner"==base_layer,queryable:!1,source:new ol.source.Stamen({layer:"toner"})}),lyrStamenToner2=new ol.layer.Tile({visible:"stamen_toner"==base_layer,queryable:!1,source:new ol.source.Stamen({layer:"toner"})}),(lyrResult=new ol.layer.Vector({source:new ol.source.Vector({}),style:function(e){return r[e.getGeometry().getType()]}})).setZIndex(99);var t=new ol.layer.Tile({visible:!1,source:new ol.source.TileWMS({url:"img/watermark/watermark.png",params:{FORMAT:"image/png",VERSION:"1.1.1",tiled:!0,STYLES:"",LAYERS:"parque_zona_ind"}}),opacity:.1,crossOrigin:null});t.setZIndex(99),map=new ol.Map({layers:[lyrBingMapsAerialWithLabels,lyrBingMapsAerial,lyrBingMapsRoad,lyrOSM,lyrEsriWorldPhysical,lyrEsriWorldTerrain,lyrEsriWorldImagery,lyrEsriWorldShadedRelief,lyrEsriWorldStreetMap,lyrStamenTerrain,lyrStamenToner,lyrResult,lyrQueryBuffer,t],interactions:ol.interaction.defaults({altShiftDragRotate:!0,rotate:!1}),target:"map",view:map_view});var a=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:"EPSG:4326",className:"custom-mouse-position",target:document.getElementById("mouse-position"),undefinedHTML:"&nbsp;"}),l=map.getView().getZoom();map_zoom=l,$("#zoom").html("Zoom: "+l),map.on("moveend",function(){l!=map.getView().getZoom()&&(l=map.getView().getZoom(),map_zoom=parseFloat(map.getView().getZoom()).toFixed(2),$("#zoom").html("Zoom: "+map_zoom))}),map.addControl(a);var i=new ol.control.ScaleLine;map.addControl(i);var n=new ol.control.FullScreen;map.addControl(n),new ol.control.OverviewMap({layers:[lyrBingMapsAerialWithLabels2,lyrBingMapsAerial2,lyrBingMapsRoad2,lyrOSM2,lyrEsriWorldPhysical2,lyrEsriWorldTerrain2,lyrEsriWorldImagery2,lyrEsriWorldShadedRelief2,lyrEsriWorldStreetMap2,lyrStamenTerrain2,lyrStamenToner2]}).setMap(map);var s=new ContextMenu({width:170,defaultItems:!0,items:[{text:"Centrar mapa aquí",icon:"img/icons/center.png",callback:function(e){map.getView().animate({duration:500,center:e.coordinate})}},{text:"Identificar",icon:"img/icons/info.png",callback:clickIdentify},{text:"Consulta por buffer",icon:"img/icons/buffer.png",callback:clickQueryBuffer}]});if(map.addControl(s),graticule=new ol.control.Graticule({step:.1,stepCoord:5,margin:5,projection:"EPSG:4326",formatCoord:function(e){return e.toFixed(1)+"°"}}),""!==window.location.hash){var c=window.location.hash.replace("#map=","").split("/");4===c.length&&(zoom=parseInt(c[0],10),center=[parseFloat(c[1]),parseFloat(c[2])],rotation=parseFloat(c[3]))}var d=map.getView();map.on("moveend",function(){if(0!=shouldUpdate){var e=d.getCenter();d.getZoom(),Math.round(100*e[0]),Math.round(100*e[1]),d.getRotation(),r={zoom:d.getZoom(),center:d.getCenter(),rotation:d.getRotation()},navigationHistoryFwd=[],navigationHistory.push(r),firstNav=!0}else if(shouldUpdate=!0,0==navigationHistory.length){var r={zoom:map.getView().getZoom(),center:map.getView().getCenter(),rotation:map.getView().getRotation()};navigationHistory.push(r)}}),map.on("click",function(e){onMapClick(e)}),activeTool="panzoom",initDictionary(),initMeasure()}function initMeasure(){sourceMeasure=new ol.source.Vector,(measureLayer=new ol.layer.Vector({source:sourceMeasure,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.3)"}),stroke:new ol.style.Stroke({color:"#c6970a",width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:"#c6970a"})})})})).setZIndex(99),map.addLayer(measureLayer)}function addInteractionMeasure(){pointerMoveHandler=function(e){if(!e.dragging){var r="Clic para empezar a dibujar";if(sketch){var o=sketch.getGeometry();o instanceof ol.geom.Polygon?r="Clic para continuar dibujando el polígono":o instanceof ol.geom.LineString&&(r="Clic para continuar dibujando la línea")}helpTooltipElement.innerHTML=r,helpTooltip.setPosition(e.coordinate),helpTooltipElement.classList.remove("hidden")}},map.on("pointermove",pointerMoveHandler),map.getViewport().addEventListener("mouseout",function(){helpTooltipElement.classList.add("hidden")});var e=$("#typeMeasure");e.on("change",function(){map.removeInteraction(drawMeasure),addInteractionMeasure()});var r,o="area"==e.val()?"Polygon":"LineString";drawMeasure=new ol.interaction.Draw({source:sourceMeasure,type:o,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.5)",lineDash:[10,10],width:2}),image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:"rgba(0, 0, 0, 0.7)"}),fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"})})})}),map.addInteraction(drawMeasure),createMeasureTooltip(),createHelpTooltip(),drawMeasure.on("drawstart",function(e){sketch=e.feature;var o=e.coordinate;r=sketch.getGeometry().on("change",function(e){var r,t=e.target;t instanceof ol.geom.Polygon?(r=formatArea(t),o=t.getInteriorPoint().getCoordinates()):t instanceof ol.geom.LineString&&(r=formatLength(t),o=t.getLastCoordinate()),measureTooltipElement.innerHTML=r,measureTooltip.setPosition(o)})},this),drawMeasure.on("drawend",function(){measureTooltipElement.className="tooltip tooltip-static",measureTooltip.setOffset([0,-7]),sketch=null,measureTooltipElement=null,createMeasureTooltip(),ol.Observable.unByKey(r)},this)}function formatLength(e){var r=ol.sphere.getLength(e);return r>100?Math.round(r/1e3*100)/100+" km":Math.round(100*r)/100+" m"}function formatArea(e){var r=ol.sphere.getArea(e);return r>1e4?Math.round(r/1e6*100)/100+" km<sup>2</sup>":Math.round(100*r)/100+" m<sup>2</sup>"}function createHelpTooltip(){helpTooltipElement&&helpTooltipElement.parentNode.removeChild(helpTooltipElement),(helpTooltipElement=document.createElement("div")).className="tooltip hidden",helpTooltip=new ol.Overlay({element:helpTooltipElement,offset:[15,0],positioning:"center-left"}),map.addOverlay(helpTooltip)}function createMeasureTooltip(){measureTooltipElement&&measureTooltipElement.parentNode.removeChild(measureTooltipElement),(measureTooltipElement=document.createElement("div")).className="tooltip tooltip-measure",measureTooltip=new ol.Overlay({element:measureTooltipElement,offset:[0,-15],positioning:"bottom-center"}),map.addOverlay(measureTooltip)}function clickPanZoom(e){}function clickIdentify(e){identify(e.coordinate)}function identify(e){new_click=!0,lyrResult.getSource().clear(),visibleLayers.length>0&&getInfo(0,e)}function clickQueryBuffer(e){showBufferDialog(e.coordinate)}function executeBuffer(e=0,r=20){var o=new ol.format.WKT,t=lyrQueryBuffer.getSource().getFeatures(),a=$("#selectLayerBuffer").val();if(t.length>0&&null!=a&&""!=a){var l=t[0],i="lib/xajax/x_query_by_geom.php?geom="+o.writeGeometry(l.getGeometry())+"&geoserver_layer_id="+a+"&limit="+r+"&page="+e;$("#btn_ejecutar_consulta_buffer").addClass("loading"),$.ajax({url:i,dataType:"json",success:function(o){if(o.success){var t=o.headers,l=o.results,i=$('<div class="search-result"></div>'),n=parseInt(o.count/r);o.count%r>0&&n++;var s='<div class="ui right floated">';e>0&&(s+='<a href="javascript:executeBuffer('+(e-1)+","+r+')">Anterior <i class="angle left icon"></i></a>'),s+=" [Página "+(e+1)+"] ",e<n-1&&(s+='<a href="javascript:executeBuffer('+(e+1)+","+r+')"><i class="angle right icon"></i> Siguiente</a>'),s+="</div>";var c="<span>";e>0&&(c+='<a href="javascript:executeBuffer('+(e-1)+","+r+')"> <i class="angle left icon"></i></a> '),c+="Página "+(e+1)+" de "+n,e<n-1&&(c+=' <a href="javascript:executeBuffer('+(e+1)+","+r+')"><i class="angle right icon"></i></a>'),c+="</span>",i.append('<div class="search-result-header"><span>Se encontraron '+o.count+" resultados</span> / "+c+" </div>");var d=$('<table class="tabla-info ui celled table"></table>'),u="<thead><tr>";u+="<th>@</th>";for(var y=1;y<t.length;y++){u+="<th>"+t[y].label+"</th>"}u+="</tr></thead>",d.append(u);var p=$("<tbody></tbody>");for(y=0;y<l.length;y++){var m=l[y],f=$('<tr data-id="'+m[0]+'" class="table-result-row"></tr>');$("<td><a href=\"javascript:showFeature('buffer','"+a+"','"+m[0]+'\')"><i class="search icon"></i></a</td>').appendTo(f);for(var g=1;g<m.length;g++)f.append("<td>"+m[g]+"</td>");$('<button class="ui tiny icon button"><i class="search icon"></i></button>');p.append(f),f.click(function(){var e=$(this).data("id");$(".table-result-row").removeClass("row-selected"),$(this).addClass("row-selected"),showFeature("buffer",a,e,!1)})}d.append(p),i.append(d),i.append(s),$("#panel_buffer_content_result").html(i),$("#btn_ejecutar_consulta_buffer").removeClass("loading")}else toastr.error(toastr.message)},error:function(e,r,o){window.console&&console.log(r+" - "+o),$("#btn_ejecutar_consulta_buffer").removeClass("loading")}})}}function clickZoomIn(e){map.getView().setZoom(map.getView().getZoom()+1),map.getView().setCenter(e.coordinate)}function clickZoomOut(e){map.getView().setZoom(map.getView().getZoom()-1),map.getView().setCenter(e.coordinate)}function exportMapImage(e){map.once("rendercomplete",function(e){var r=e.context.canvas;navigator.msSaveBlob?navigator.msSaveBlob(r.msToBlob(),"map.png"):r.toBlob(function(e){saveAs(e,"map.png")})}),map.renderSync()}function doPanZoom(e,r){map_view.animate({center:e,zoom:r,duration:500})}function doPanZoomRotate(e,r,o){map_view.animate({center:e,zoom:r,rotation:o,duration:200})}var diccionario=[];function initDictionary(){$.ajax({url:"lib/xajax/x_get_dictionary.php",dataType:"json",success:function(e){dictionary=e.results},error:function(e,r,o){window.console&&console.log(r+" - "+o)}})}function showResult(e){new_click?(new_click=!1,showPanelResult("")):$("#panel_info_content").append("")}function getInfo(e,r){var o=visibleLayers[e],t=getLayer(o),a=t.get("name");if(t.get("queryable")){var l=t.get("geoserver_layer_id"),i=t.getSource().getFeatureInfoUrl(r,map.getView().getResolution(),map.getView().getProjection(),{INFO_FORMAT:"application/json",query_layers:t.getSource().getParams().layers});if(i){var n=new ol.format.GeoJSON({featureProjection:"EPSG:4326"});$.getJSON(i,function(o){var t=n.readFeatures(o);if(t.length){var i=t[0].getKeys();content="<span>"+a+" ("+t.length+")</span>",content+='<table class="tabla-info ui celled table">',content+="<tbody>";for(var s=[],c=0;c<i.length;c++){var d=i[c];if("geometry"!=d){var u=!1,y="";$.each(dictionary,function(e,r){l==r.layer&&d==r.attribute&&(y=r.label,display_order=r.display_order,u=!0)}),u&&s.push({label:y,value:t[0].get(d),display_order:display_order})}}for(c=0;c<s.length-1;c++)for(var p=c;p<s.length;p++)if(parseInt(s[c].display_order)>parseInt(s[p].display_order)){var m=s[c];s[c]=s[p],s[p]=m}for(c=0;c<s.length;c++)content+="<tr><td>"+s[c].label+"</td><td>"+s[c].value+"</td></tr>";content+="</tbody>",content+="</table>",new_click?(new_click=!1,showPanelResult(content)):$("#panel_info_content").append(content),lyrResult.getSource().addFeatures(t)}++e<visibleLayers.length&&getInfo(e,r)})}}else++e<visibleLayers.length&&getInfo(e,r)}function showPanelResult(e){null==panelInfo?panelInfo=jsPanel.create({id:"panelInfo",theme:"primary",contentSize:{width:function(){return Math.min(400,window.innerWidth/4)},height:function(){return 400}},position:"right-top 10 70",animateIn:"jsPanelFadeIn",headerTitle:'<i class="info circle icon"></i> Información',dragit:{snap:!0},content:'<div id="panel_info_content">'+e+"</div>",onwindowresize:!0}):$("#panel_info_content").html(e)}function onMapClick(e){"panzoom"==activeTool?clickPanZoom(e):"identify"==activeTool?clickIdentify(e):"zoomin"==activeTool?clickZoomIn(e):"zoomout"==activeTool&&clickZoomOut(e)}function refreshActiveLayersBufferDialog(){for(var e="",r=0;r<visibleLayers.length;r++){var o=getLayer(visibleLayers[r]);e+='<option value="'+o.get("geoserver_layer_id")+'">'+o.get("name")+"</option>"}$("#selectLayerBuffer").html(e)}function showBufferDialog(e){setBuffer(e,500);var r='<div class="ui form">';r+='<div class="inline field"><label>Radio (metros):</label><input style="width:80px;" type="text" class="form-control input-sm" id="radioBuffer" placeholder="Radio (metros)" value="500"> <button class="ui mini button" onclick="setBuffer(['+e[0]+","+e[1]+"], $('#radioBuffer').val())\">Generar buffer</button></div>",r+='<div class="inline field"><label>Capa a consultar:</label><select id="selectLayerBuffer" class="ui mini search selection dropdown"></select></div>',r+='<div class="inline field"><button id="btn_ejecutar_consulta_buffer" class="ui mini button" onclick="executeBuffer()" disabled>Consultar</button></div>',r+='<div id="panel_buffer_content_result"></div>',r+="</div>",null==panelBuffer?panelBuffer=jsPanel.create({id:"panelBuffer",theme:"primary",contentOverflow:"scroll",contentSize:{width:function(){return Math.min(500,window.innerWidth/4)},height:function(){return 400}},position:{my:"right-top",at:"right-top",offsetX:15,offsetY:69},animateIn:"jsPanelFadeIn",headerTitle:'<i class="search icon"></i> Consulta por buffer (radio)',dragit:{snap:!0},content:'<div id="panel_buffer_content">'+r+"</div>",onwindowresize:!0}):$("#panel_buffer_content").html(r),refreshActiveLayersBufferDialog()}function initControls(){activateTool("identify"),$("#select_capa_base").on("change",function(){selectBaseLayer()}),$("#select_geovisor").on("change",function(){selectGeovisor()}),$(".dropdown").dropdown(),$("#toolHome").click(function(){doPanZoom(coord_ini,zoom_ini)}),$("#toolExport").click(function(e){exportMapImage(e)}),$(".ctrl-geovisor").popup(),$("#toolDragPan").click(function(){deactivateTool(),$(this).hasClass("active")||(document.getElementById("map").style.cursor="default",activateTool("panzoom"))}),$("#toolIdentify").click(function(){deactivateTool(),$(this).hasClass("active")||activateTool("identify")}),$("#toolZoomIn").click(function(){deactivateTool(),$(this).hasClass("active")||(document.getElementById("map").style.cursor="zoom-in",activateTool("zoomin"))}),$("#toolZoomOut").click(function(){deactivateTool(),$(this).hasClass("active")||(document.getElementById("map").style.cursor="zoom-out",activateTool("zoomout"))}),$("#toolZoomBack").click(function(){var e=navigationHistory.pop();firstNav&&(navigationHistoryFwd.push(e),e=navigationHistory.pop(),firstNav=!1),null!=e&&null!=e&&(navigationHistoryFwd.push(e),doPanZoomRotate(e.center,e.zoom,e.rotation),shouldUpdate=!1,$("#toolZoomForward").removeClass("disabled"))}),$("#toolZoomForward").click(function(){var e=navigationHistoryFwd.pop();null!=e&&null!=e?(navigationHistory.push(e),doPanZoomRotate(e.center,e.zoom,e.rotation),shouldUpdate=!1):$("#toolZoomForward").addClass("disabled")}),$("#toolMeasure").click(function(){deactivateTool(),$(this).hasClass("active")||activateTool("measure")}),$("#toolGraticule").click(function(){$(this).hasClass("active")?(graticule.setMap(null),$(this).removeClass("active")):(graticule.setMap(map),$(this).addClass("active"))})}function activateTool(e){switch(e){case"panzoom":$("#toolDragPan").addClass("active");break;case"identify":$("#toolIdentify").addClass("active");break;case"zoomin":$("#toolZoomIn").addClass("active");break;case"zoomout":$("#toolZoomOut").addClass("active");break;case"measure":$("#typeMeasure").show(),addInteractionMeasure(),$("#toolMeasure").addClass("active")}activeTool=e}function deactivateTool(){switch(activeTool){case"panzoom":$("#toolDragPan").removeClass("active");break;case"identify":$("#toolIdentify").removeClass("active");break;case"zoomin":$("#toolZoomIn").removeClass("active");break;case"zoomout":$("#toolZoomOut").removeClass("active");break;case"measure":map.removeInteraction(drawMeasure),sourceMeasure.clear(),$("#typeMeasure").hide(),map.getOverlays().getArray().slice(0).forEach(function(e){map.removeOverlay(e)}),$("#toolMeasure").removeClass("active"),ol.Observable.unByKey(pointerMoveHandler)}}function initPopups(){var e=document.getElementById("context_menu"),r=document.getElementById("context_menu_closer");lyrContextMenu=new ol.Overlay({element:e,autoPan:!0,autoPanAnimation:{duration:250}}),r.onclick=function(){return lyrContextMenu.setPosition(void 0),r.blur(),lyrQueryBuffer.getSource().clear(),!1},map.addOverlay(lyrContextMenu)}function setBuffer(e,r){var o=new jsts.io.OL3Parser,t=new ol.geom.Point(e),a=(r=r,o.read(t).buffer(r)),l=o.write(a);lyrQueryBuffer.getSource().clear();var i=new ol.Feature({geometry:l,name:"Buffer"});lyrQueryBuffer.getSource().addFeature(i),$("#btn_ejecutar_consulta_buffer").removeAttr("disabled")}function selectBaseLayer(){var e=$("#select_capa_base").val();switch(lyrBingMapsAerial.setVisible(!1),lyrBingMapsAerialWithLabels.setVisible(!1),lyrBingMapsRoad.setVisible(!1),lyrOSM.setVisible(!1),lyrStamenTerrain.setVisible(!1),lyrStamenToner.setVisible(!1),lyrEsriWorldPhysical.setVisible(!1),lyrEsriWorldTerrain.setVisible(!1),lyrEsriWorldImagery.setVisible(!1),lyrEsriWorldShadedRelief.setVisible(!1),lyrEsriWorldStreetMap.setVisible(!1),lyrBingMapsAerial2.setVisible(!1),lyrBingMapsAerialWithLabels2.setVisible(!1),lyrBingMapsRoad2.setVisible(!1),lyrOSM2.setVisible(!1),lyrStamenTerrain2.setVisible(!1),lyrStamenToner2.setVisible(!1),lyrEsriWorldPhysical2.setVisible(!1),lyrEsriWorldTerrain2.setVisible(!1),lyrEsriWorldImagery2.setVisible(!1),lyrEsriWorldShadedRelief2.setVisible(!1),lyrEsriWorldStreetMap2.setVisible(!1),e){case"bingaerial":lyrBingMapsAerial.setVisible(!0),lyrBingMapsAerial2.setVisible(!0);break;case"bingaeriallabels":lyrBingMapsAerialWithLabels.setVisible(!0),lyrBingMapsAerialWithLabels2.setVisible(!0);break;case"bingroad":lyrBingMapsRoad.setVisible(!0),lyrBingMapsRoad2.setVisible(!0);break;case"osm":lyrOSM.setVisible(!0),lyrOSM2.setVisible(!0);break;case"stamen_terrain":lyrStamenTerrain.setVisible(!0),lyrStamenTerrain2.setVisible(!0);break;case"stamen_toner":lyrStamenToner.setVisible(!0),lyrStamenToner2.setVisible(!0);break;case"esriworldphysical":lyrEsriWorldPhysical.setVisible(!0),lyrEsriWorldPhysical2.setVisible(!0);break;case"esriworldshadedrelief":lyrEsriWorldShadedRelief.setVisible(!0),lyrEsriWorldShadedRelief2.setVisible(!0);break;case"esriworldterrain":lyrEsriWorldTerrain.setVisible(!0),lyrEsriWorldTerrain2.setVisible(!0);break;case"esriworldimagery":lyrEsriWorldImagery.setVisible(!0),lyrEsriWorldImagery2.setVisible(!0);break;case"esriworldstreetmap":lyrEsriWorldStreetMap.setVisible(!0),lyrEsriWorldStreetMap2.setVisible(!0)}}function selectGeovisor(){var e=$("#select_geovisor").val(),r=$("#select_geovisor").text();jsPanel.create({id:"panelCapas"+e,theme:"primary",contentSize:{width:function(){return Math.min(400,.5*window.innerWidth)},height:function(){return window.innerHeight-300}},position:"left-top 30 40",animateIn:"jsPanelFadeIn",headerTitle:'<i class="map marker icon"></i> Capas de información '+r,headerControls:{},dragit:{containment:[60,10,10,10]},content:function(r){$(this.content).load("ctrl/layer_control.php?geovisor_id="+e+"&access_token="+access_token,function(){})},onwindowresize:!0})}function openHtmlMenu(e,r,o){jsPanel.create({id:"panelMenu"+r,theme:"primary",contentSize:{width:function(){return Math.min(600,.7*window.innerWidth)},height:function(){return window.innerHeight-300}},position:"right-top 30 40",animateIn:"jsPanelFadeIn",headerTitle:'<i class="map marker icon"></i> '+o,headerControls:{},dragit:{containment:[60,10,10,10]},content:function(o){$(this.content).load("ctrl/menu_html_control.php?geovisor_id="+e+"&menu_id="+r,function(){})},onwindowresize:!0})}$(".ol-ctx-menu-container").addClass("ol-ctx-menu-hidden"),initMap(),initControls(),initPopups(),$("#modal_ini").modal("show"),jsPanel.create({id:"panelCapas",theme:"primary",container:"#map",contentSize:{width:function(){return Math.min(400,.5*window.innerWidth)},height:function(){return window.innerHeight-200}},position:"left-top 10 70",animateIn:"jsPanelFadeIn",headerTitle:'<i class="map marker icon"></i> Panel de información geográfica',headerControls:{close:"remove",maximize:"remove"},dragit:{containment:[60,10,10,10]},content:function(e){$(this.content).load("ctrl/layer_control.php?geovisor_id="+geovisor_id+"&access_token="+access_token,function(){})},onwindowresize:!0}),document.addEventListener("jspanelclosed",function(e){switch(e.detail){case"panelMetadatos":panelMetadatos=null;break;case"panelInfo":panelInfo=null,lyrResult.getSource().clear();break;case"panelBuffer":panelBuffer=null,lyrQueryBuffer.getSource().clear();break;case"panelSearchResult":panelSearchResult=null,lyrResult.getSource().clear()}});